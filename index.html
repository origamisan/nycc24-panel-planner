<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Fun WithPanels</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <style>
      .panel {
        border: 2px solid blue;
        margin: 5px;
      }
      .instance {
        border: 1px solid black;
        margin: 5px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
      var DateTime = luxon.DateTime;
      var schedules;
      var panelnames = [];
      var panels = [];
      var calendar = [];

      function time_available(tmpcal) {
        valid = true;
        var tmp_start = DateTime.fromISO(tmpcal.start_time);
        var tmp_end = DateTime.fromISO(tmpcal.end_time);
        $.each(calendar, function (index, entry) {
          var e_start = DateTime.fromISO(entry.start_time);
          var e_end = DateTime.fromISO(entry.end_time);
          console.log(e_start);
          console.log(tmp_start);
          if (tmp_start >= e_start && tmp_start < e_end) {
            valid = false;
          }
          if (tmp_end >= e_start && tmp_end < e_end) {
            valid = false;
          }
        });
        return valid;
      }

      function add_to_calendar(tmpcal) {
        alert(time_available(tmpcal));
        calendar.push(tmpcal);
        localStorage.setItem("calendar", JSON.stringify(calendar));
      }

      function render_stage() {
        $("#stage").html("");
        $.each(panels, function (index, panel) {
          if (panel.status === "eval") {
            var html = "";
            html =
              "<div class='card' style='margin-bottom:5px;' data-index='" +
              panel.index +
              "'><div class='card-body'>" +
              "<h2 class='card-title'>" +
              panel.title +
              "</h2>" +
              "<button type='button' class='btn btn-success choose' style='margin:5px;' data-index='" +
              panel.index +
              "'>Choose</button>" +
              "<button type='button' class='btn btn-danger reject' data-index='" +
              panel.index +
              "'>Reject</button>" +
              "<p class=card-text>" +
              panel.description +
              "</p>";

            $.each(panel.instances, function (index, instance) {
              html +=
                "<div class='instance'> Start: " +
                instance.start_time +
                " End: " +
                instance.end_time +
                " Location: " +
                instance.location +
                "</div>";
            });
            html += "</div></div>";
            //alert(html);
            $("#stage").append(html);
          }
        });
      }

      function render_chosen() {
        $.each(panels, function (index, panel) {
          if (panel.status === "chosen") {
            var html = "";
            html =
              "<div class='card' style='margin-bottom:5px;' data-index='" +
              panel.index +
              "'><div class='card-body'>" +
              "<h2 class='card-title'>" +
              panel.title +
              "</h2>" +
              // "<button type='button' class='btn btn-success choose' style='margin:5px;' data-index='" +
              // panel.index +
              // "'>Choose</button>" +
              "<button type='button' class='btn btn-primary unchoose' data-index='" +
              panel.index +
              "'>Unchoose</button>" +
              "<p class=card-text>" +
              panel.description +
              "</p>";

            $.each(panel.instances, function (index, instance) {
              html +=
                "<div class='btn btn-outline-info instance' data-id='" +
                panel.index +
                "-" +
                instance.index +
                "' data-title='" +
                panel.title +
                "' data-start='" +
                instance.start_time.replace(" ", "T") +
                "' data-end='" +
                instance.end_time.replace(" ", "T") +
                "' data-location='" +
                instance.location +
                "'> Start: " +
                instance.start_time +
                " End: " +
                instance.end_time +
                " Location: " +
                instance.location +
                "</div>";
            });
            html += "</div></div>";
            //alert(html);
            $("#chosen").append(html);
          }
        });
      }

      function render_rejected() {
        $.each(panels, function (index, panel) {
          if (panel.status === "rejected") {
            var html = "";
            html =
              "<div class='card' style='margin-bottom:5px;' data-index='" +
              panel.index +
              "'><div class='card-body'>" +
              "<h2 class='card-title'>" +
              panel.title +
              "</h2>" +
              // "<button type='button' class='btn btn-success choose' style='margin:5px;' data-index='" +
              // panel.index +
              // "'>Choose</button>" +
              "<button type='button' class='btn btn-primary unreject' data-index='" +
              panel.index +
              "'>Unreject</button>" +
              "<p class=card-text>" +
              panel.description +
              "</p>";

            $.each(panel.instances, function (index, instance) {
              html +=
                "<div class='instance'> Start: " +
                instance.start_time +
                " End: " +
                instance.end_time +
                " Location: " +
                instance.location +
                "</div>";
            });
            html += "</div></div>";
            //alert(html);
            $("#rejected").append(html);
          }
        });
      }

      $(document).ready(function () {
        if (localStorage.getItem("panels")) {
          panels = JSON.parse(localStorage.getItem("panels"));
          if (localStorage.getItem("calendar")) {
            calendar = JSON.parse(localStorage.getItem("calendar"));
          }
          render_stage();
          render_chosen();
          render_rejected();
        } else {
          $.getJSON(
            "https://register.growtix.com/api/schedules?key=0a00c84d-7546-45e1-a596-96594b5cc463",
            function (jd) {
              schedules = jd.schedules.sort((a, b) =>
                a.title.localeCompare(b.title)
              );
              var tmppanel = {};
              $.each(schedules, function (index, panel) {
                if (panelnames.indexOf(panel.title) == -1) {
                  if (
                    Object.entries(tmppanel).length === 0 &&
                    panels.length === 0
                  ) {
                    console.log("Starting Panel Ingest");
                  } else {
                    panels.push(tmppanel);
                    tmppanel = {};
                  }
                  panelnames.push(panel.title);
                  tmppanel.index = panels.length;
                  tmppanel.status = "eval";
                  tmppanel.title = panel.title;
                  tmppanel.description = panel.description;
                  tmppanel.instances = [];
                  var tmpinstance = {};
                  tmpinstance.index = 0;
                  tmpinstance.start_time = panel.start_time;
                  tmpinstance.end_time = panel.end_time;
                  tmpinstance.location = panel.location;
                  tmppanel.instances.push(tmpinstance);
                  // create the panel
                } else {
                  var tmpinstance = {};
                  tmpinstance.index = tmppanel.instances.length;
                  tmpinstance.start_time = panel.start_time;
                  tmpinstance.end_time = panel.end_time;
                  tmpinstance.location = panel.location;
                  tmppanel.instances.push(tmpinstance);
                }
                //console.log(panels.indexOf(panel.title));
              });
              console.log(panels);
              localStorage.setItem("panels", JSON.stringify(panels));
              render_stage();
            }
          );
        }
        $("#stage").on("click", ".reject", function (e) {
          panels[$(this).attr("data-index")].status = "rejected";
          $(this).parent().parent().remove();
          render_rejected();
          localStorage.setItem("panels", JSON.stringify(panels));
        });
        $("#stage").on("click", ".choose", function (e) {
          panels[$(this).attr("data-index")].status = "chosen";
          $(this).parent().parent().remove();
          render_chosen();
          localStorage.setItem("panels", JSON.stringify(panels));
        });
        $("#chosen").on("click", ".unchoose", function (e) {
          panels[$(this).attr("data-index")].status = "eval";
          $(this).parent().parent().remove();
          render_stage();
          localStorage.setItem("panels", JSON.stringify(panels));
        });
        $("#chosen").on("click", ".instance", function (e) {
          console.log($(this));
          var tmpcal = {};
          tmpcal.start_time = $(this).attr("data-start");
          tmpcal.end_time = $(this).attr("data-end");
          tmpcal.id = $(this).attr("data-id");
          tmpcal.location = $(this).attr("data-location");
          tmpcal.title = $(this).attr("title");
          $(this).removeClass("btn-outline-info");
          $(this).addClass("btn-success");
          add_to_calendar(tmpcal);
        });
        $("#rejected").on("click", ".unreject", function (e) {
          panels[$(this).attr("data-index")].status = "eval";
          $(this).parent().parent().remove();
          render_stage();
          localStorage.setItem("panels", JSON.stringify(panels));
        });
      });
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="accordion" id="accordionExample">
        <div class="accordion-item" style="background-color: #aae">
          <h2 class="accordion-header">
            <button
              class="accordion-button"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseOne"
              aria-expanded="true"
              aria-controls="collapseOne"
              style="background-color: #aae"
            >
              Panels
            </button>
          </h2>
          <div
            id="collapseOne"
            class="accordion-collapse collapse show"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body">
              <div id="stage"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item" style="background-color: #e88">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseTwo"
              aria-expanded="false"
              aria-controls="collapseTwo"
              style="background-color: #e88"
            >
              Rejected
            </button>
          </h2>
          <div
            id="collapseTwo"
            class="accordion-collapse collapse"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body">
              <div id="rejected"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item" style="background-color: #aea">
          <h2 class="accordion-header">
            <button
              class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseThree"
              aria-expanded="false"
              aria-controls="collapseThree"
              style="background-color: #aea"
            >
              Chosen
            </button>
          </h2>
          <div
            id="collapseThree"
            class="accordion-collapse collapse"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body">
              <div id="chosen"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
